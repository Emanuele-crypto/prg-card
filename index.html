<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
<!-- Importazione librerie esterne -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
* {
   margin: 0;
   padding: 0;
   box-sizing: border-box;
}

body { 
   font-family: 'Arial', sans-serif;
   font-size: 16px;
   line-height: 1.3;
   color: #000000;
   margin: 10px;
   background-color: #f5f5f5;
}

.header {
   text-align: center;
   margin-bottom: 15px;
   background: #1e3c72;
   border: 2px solid #000000;
   padding: 10px;
   border-radius: 8px;
   color: #ffffff;
}

.header h1 {
   font-size: 20px;
   margin-bottom: 5px;
   font-weight: bold;
   color: #ffffff;
}

.header .subtitle {
   font-size: 16px;
   margin-bottom: 5px;
   color: #ffffff;
}

.header-info {
   display: flex;
   justify-content: space-around;
   margin-top: 8px;
   font-size: 14px;
   color: #ffffff;
}

.controls-section {
   background-color: #e9ecef;
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 10px;
   margin-bottom: 15px;
   display: flex;
   gap: 15px;
   align-items: center;
   flex-wrap: wrap;
}

.controls-section .form-group {
   display: flex;
   flex-direction: column;
   min-width: 150px;
}

.controls-section label {
   font-weight: bold;
   margin-bottom: 3px;
   color: #000000;
   font-size: 12px;
}

.controls-section .form-control,
.controls-section .form-select {
   border: 1px solid #000000;
   border-radius: 4px;
   padding: 5px;
   font-size: 12px;
}

.btn {
   padding: 6px 12px;
   border: none;
   border-radius: 5px;
   font-weight: bold;
   cursor: pointer;
   text-decoration: none;
   display: inline-block;
   margin: 3px;
   font-size: 11px;
}

.btn-primary {
   background: #1e3c72;
   color: white;
}

.btn-success {
   background: #28a745;
   color: white;
}

.btn-warning {
   background: #ffc107;
   color: #000000;
}

.btn-danger {
   background: #dc3545;
   color: white;
}

.btn-info {
   background: #17a2b8;
   color: white;
}

.totals-section {
   display: flex;
   justify-content: space-around;
   margin-bottom: 15px;
   background-color: #ffc107;
   padding: 10px;
   border: 1px solid #000000;
   border-radius: 5px;
}

.total-item {
   text-align: center;
   color: #000000;
}

.total-value {
   font-size: 18px;
   font-weight: bold;
   color: #000000;
}

.total-label {
   font-size: 12px;
   margin-top: 2px;
   color: #000000;
}

/* LAYOUT GRIGLIA 4x2 */
.main-grid {
   display: grid;
   grid-template-columns: repeat(4, 1fr);
   grid-template-rows: repeat(2, auto);
   gap: 8px;
   min-height: 80vh;
}

/* POSIZIONAMENTO DELLE CARD */
.card-position-1 { grid-column: 1; grid-row: 1; }
.card-position-2 { grid-column: 2; grid-row: 1; }
.card-position-3 { grid-column: 3; grid-row: 1; }
.card-position-4 { grid-column: 4; grid-row: 1; }
.card-position-5 { grid-column: 1; grid-row: 2; }
.card-position-6 { grid-column: 2; grid-row: 2; }
.card-position-7 { grid-column: 3; grid-row: 2; }
.card-position-8 { grid-column: 4; grid-row: 2; }

.supplier-card {
   background-color: #e9ecef;
   border: 2px solid #000000;
   border-radius: 8px;
   padding: 8px;
   min-height: 300px;
   font-size: 11px;
}

.destinazione-card {
   background-color: #f0f8ff;
   border: 2px solid #007bff;
   border-radius: 8px;
   padding: 8px;
   min-height: 300px;
   font-size: 11px;
}

.card-header {
   background: #6c757d;
   color: #ffffff;
   padding: 4px;
   text-align: center;
   font-weight: bold;
   font-size: 12px;
   margin: -8px -8px 8px -8px;
   border-radius: 6px 6px 0 0;
}

.destinazione-header {
   background: #007bff;
   color: #ffffff;
   padding: 4px;
   text-align: center;
   font-weight: bold;
   font-size: 12px;
   margin: -8px -8px 8px -8px;
   border-radius: 6px 6px 0 0;
}

.form-row {
   display: flex;
   justify-content: space-between;
   margin-bottom: 4px;
   align-items: center;
}

.form-label {
   font-weight: bold;
   color: #000000;
   width: 35%;
   font-size: 10px;
}

.form-input {
   width: 63%;
}

.form-input input,
.form-input select {
   width: 100%;
   border: 1px solid #000000;
   border-radius: 3px;
   padding: 2px;
   font-size: 9px;
}

.calculated-field {
   background-color: #e7f3ff;
   font-weight: bold;
   text-align: center;
}

.yield-result {
   background-color: #e8f5e8;
   font-weight: bold;
   text-align: center;
}

.bio-red-field {
   color: #dc3545 !important;
   font-weight: bold;
   border-color: #dc3545 !important;
}

.bio-black-field {
   color: #000000 !important;
   font-weight: bold;
   border-color: #495057 !important;
}

.bio-red-text {
   color: #dc3545 !important;
   font-weight: bold;
}

.bio-black-text {
   color: #000000 !important;
   font-weight: bold;
}

.section-divider {
   border-bottom: 1px solid #6c757d;
   margin: 4px 0;
}

.destination-section {
   background-color: #f8f9fa;
   border: 1px solid #17a2b8;
   border-radius: 5px;
   padding: 5px;
   margin-top: 5px;
}

.destination-section-header {
   background: #17a2b8;
   color: white;
   padding: 2px 4px;
   border-radius: 3px;
   font-weight: bold;
   font-size: 9px;
   margin: -5px -5px 5px -5px;
   text-align: center;
}

.remaining-qty {
   background-color: #e7f3ff;
   border: 1px solid #2a5298;
   padding: 2px;
   border-radius: 3px;
   font-weight: bold;
   text-align: center;
   color: #1e3c72;
   font-size: 9px;
   margin: 3px 0;
}

.transfer-row {
   display: flex;
   align-items: center;
   gap: 2px;
   margin-top: 3px;
}

.transfer-row .form-label {
   min-width: 25px;
   margin-bottom: 0;
   font-size: 8px;
   flex-shrink: 0;
}

.transfer-row .transfer-destination {
   flex: 1;
   font-size: 8px;
}

.transfer-row .transfer-qty {
   width: 30px;
   font-size: 8px;
   padding: 1px;
}

.transfer-row .btn {
   padding: 1px 3px;
   font-size: 7px;
   margin: 0;
}

.hidden-field {
   display: none;
}

.save-status {
   background-color: #d4edda;
   border: 1px solid #28a745;
   color: #155724;
   padding: 8px;
   border-radius: 5px;
   margin-bottom: 15px;
   text-align: center;
   display: none;
   font-size: 12px;
}

.save-error {
   background-color: #f8d7da;
   border: 1px solid #dc3545;
   color: #721c24;
}

/* REGOLE DI STAMPA */
@media print {
   body { 
       margin: 5mm !important;
       background-color: white !important;
       font-size: 14px !important;
   }
   
   .controls-section {
       display: none !important;
   }
   
   .btn {
       display: none !important;
   }
   
   .header {
       background: #1e3c72 !important;
       color: #ffffff !important;
       border: 2px solid #000000 !important;
       margin-bottom: 10px !important;
   }
   
   .totals-section {
       background-color: #ffc107 !important;
       border: 2px solid #000000 !important;
       margin-bottom: 10px !important;
   }
   
   .main-grid {
       gap: 5px !important;
       min-height: auto !important;
   }
   
   .supplier-card,
   .destinazione-card {
       background-color: #ffffff !important;
       border: 2px solid #000000 !important;
       font-size: 10px !important;
       min-height: 200px !important;
       page-break-inside: avoid;
   }
   
   .form-input input,
   .form-input select {
       font-size: 8px !important;
       background-color: #ffffff !important;
       border: 1px solid #000000 !important;
   }
   
   .calculated-field,
   .yield-result {
       background-color: #f0f0f0 !important;
       border: 1px solid #000000 !important;
   }
   
   @page {
       margin: 5mm;
       size: A4 landscape;
   }
}
</style>
</head>

<body>
   <div class="header">
       <h1>PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
       <div class="subtitle">Sistema di Gestione Produzione - Simone Gatto</div>
       <div class="header-info">
           <div><strong>Data:</strong> <span id="current-date"></span></div>
           <div><strong>Agrume:</strong> <span id="selected-agrume">N/D</span></div>
           <div><strong>Cards:</strong> <span id="cards-count">0</span></div>
       </div>
       <div style="margin-top: 8px; font-size: 12px;">
           <strong>Generato:</strong> <span id="last-revision"></span>
       </div>
   </div>

   <!-- Status salvataggio -->
   <div id="save-status" class="save-status">
       <span id="save-message"></span>
   </div>

   <!-- Sezione Controlli -->
   <div class="controls-section">
       <div class="form-group">
           <label for="tipo-agrume-giornaliero">Tipo di Agrume</label>
           <select class="form-select" id="tipo-agrume-giornaliero" required>
               <option value="">Seleziona il tipo di agrume</option>
               <option value="LIMONE">Limone</option>
               <option value="ARANCIA">Arancia</option>
               <option value="MANDARINO">Mandarino</option>
               <option value="POMPELMO">Pompelmo</option>
               <option value="BERGAMOTTO">Bergamotto</option>
           </select>
       </div>
       
       <div class="form-group">
           <label for="data-lavorazione">Data Lavorazione</label>
           <input type="date" class="form-control" id="data-lavorazione" required>
       </div>
       
       <div>
           <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
               <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
           </button>
           <button type="button" class="btn btn-success" id="aggiungi-destinazione">
               <i class="bi bi-plus-square"></i> Aggiungi Destinazione
           </button>
           <button type="button" class="btn btn-info" id="salva-file">
               <i class="bi bi-download"></i> Salva File
           </button>
           <button type="button" class="btn btn-info" id="carica-file">
               <i class="bi bi-upload"></i> Carica File
           </button>
           <button type="button" class="btn btn-warning" onclick="window.print()">
               <i class="bi bi-printer"></i> Stampa
           </button>
           <button type="button" class="btn btn-danger" id="reset-programma">
               <i class="bi bi-arrow-clockwise"></i> Reset
           </button>
       </div>
   </div>

   <!-- Sezione Totali -->
   <div class="totals-section">
       <div class="total-item">
           <div class="total-value" id="entrata-giornaliera-display">0</div>
           <div class="total-label">Kg Entrata Totale</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="trasformata-totale-display">0</div>
           <div class="total-label">Kg Trasformati</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="giacenza-totale-display">0</div>
           <div class="total-label">Kg Giacenza</div>
       </div>
   </div>

   <!-- Griglia principale 4x2 -->
   <div class="main-grid" id="main-grid">
       <!-- Le card verranno aggiunte dinamicamente qui -->
   </div>

   <!-- Input file nascosto per caricamento -->
   <input type="file" id="file-input" accept=".json" style="display: none;">

<script>
$(document).ready(function() {
   let cardCounter = 0;
   let supplierCount = 0;
   let destinazioneCount = 0;
   let cardPositions = []; // Array per tracciare le posizioni occupate

   // Variabili per gestione trasferimenti
   let transferData = {};
   let transferredAmounts = {};

   // Definizione varietà per ogni tipo di agrume
   const varietyOptions = {
       'LIMONE': [
           { value: 'VERDELLO', text: 'Verdello' },
           { value: 'FEMMINELLO', text: 'Femminello' },
           { value: 'INTERDONATO', text: 'Interdonato' },
           { value: 'BIANCHETTO', text: 'Bianchetto' },
           { value: 'MONACHELLO', text: 'Monachello' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ],
       'MANDARINO': [
           { value: 'TARD. DI CIACULLI', text: 'Tard. di Ciaculli' },
           { value: 'AVANA', text: 'Avana' },
           { value: 'CLEMENTINO', text: 'Clementino' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ],
       'ARANCIA': [
           { value: 'BIONDA', text: 'Bionda' },
           { value: 'ROSSA', text: 'Rossa' },
           { value: 'MORO', text: 'Moro' },
           { value: 'SANGUINELLA', text: 'Sanguinella' },
           { value: 'TAROCCO', text: 'Tarocco' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ],
       'BERGAMOTTO': [
           { value: 'FEMMINELLO', text: 'Femminello' },
           { value: 'CASTAGNARO', text: 'Castagnaro' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ],
       'POMPELMO': [
           { value: 'GIALLO', text: 'Giallo' },
           { value: 'ROSA', text: 'Rosa' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ]
   };

   // Rese per linea di trasformazione
   const yieldsPerLine = {
       'BOE/1100': 31.30,
       'GOE EST/400': 31.60,
       '400': 32.00,
       'GOE EST/POLY': 30.60,
       'GOE INT/POLY': 28.30,
       'BIRILLATRICI': 26.60,
       'GOE EST/BIRILLATRICI': 25.60
   };

   // Inizializzazione data corrente e ultima revisione
   function initCurrentDate() {
       const today = new Date();
       const formatted = today.toLocaleDateString('it-IT', {
           weekday: 'long',
           year: 'numeric',
           month: 'long',
           day: 'numeric'
       });
       $('#current-date').text(formatted);
       $('#data-lavorazione').val(today.toISOString().split('T')[0]);
       
       updateLastRevision();
   }

   // Aggiorna ultima revisione
   function updateLastRevision() {
       const now = new Date();
       const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
       $('#last-revision').text(lastRevision);
   }

   // Funzione per ottenere la resa in base alla linea di trasformazione
   function getYieldByLine(linea) {
       return yieldsPerLine[linea] || 30;
   }

   // Funzione per ottenere la prossima posizione disponibile
   function getNextAvailablePosition() {
       for (let i = 1; i <= 8; i++) {
           if (!cardPositions.includes(i)) {
               return i;
           }
       }
       return null; // Tutte le posizioni sono occupate
   }

   // Crea card fornitore SEMPLIFICATA
   function createSupplierCard(index) {
       const position = getNextAvailablePosition();
       if (!position) {
           alert('Massimo 8 card raggiunto!');
           return null;
       }

       cardPositions.push(position);
       const agrume = $('#tipo-agrume-giornaliero').val();
       const defaultYield = 30;

       const varietyOptionsHtml = agrume && varietyOptions[agrume] ? 
           varietyOptions[agrume].map(v => `<option value="${v.value}">${v.text}</option>`).join('') : 
           '<option value="">Seleziona prima l\'agrume</option>';

       return `
           <div class="supplier-card card-position-${position}" data-supplier-index="${index}" data-position="${position}">
               <div class="card-header">F${index} - <span class="supplier-name">Nuovo Fornitore</span></div>
               
               <div class="form-row">
                   <span class="form-label">Nome:</span>
                   <div class="form-input">
                       <select class="nome-fornitore" onchange="updateSupplierName(${index})">
                           <option value="">Seleziona fornitore</option>
                           <option value="RESTUCCIA">RESTUCCIA</option>
                           <option value="CI">CI</option>
                           <option value="ARCO">ARCO</option>
                           <option value="GIOVINAZZO">GIOVINAZZO</option>
                           <option value="AZ.T.C.">AZ.T.C.</option>
                           <option value="M.B.T.F.">M.B.T.F.</option>
                           <option value="VASTA">VASTA</option>
                           <option value="APAL">APAL</option>
                           <option value="GEIMA">GEIMA</option>
                           <option value="UNIONBERG">UNIONBERG</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                       <input type="text" class="altro-fornitore hidden-field" placeholder="Altro" style="margin-top: 2px;">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Entrata (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-fornitore" min="0" onchange="calculateSupplier(${index})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Trasformata (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-trasformata" min="0" onchange="calculateSupplier(${index})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Giacenza (kg):</span>
                   <div class="form-input">
                       <input type="number" class="giacenza-fornitore calculated-field" readonly>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Certificazione:</span>
                   <div class="form-input">
                       <select class="certificazione-prodotto" onchange="updateBioStyles(${index})">
                           <option value="">Seleziona</option>
                           <option value="BIO EU">BIO EU</option>
                           <option value="BIO DEM">BIO DEM</option>
                           <option value="BIO NTD">BIO NTD</option>
                           <option value="BIO DEM/NTD">BIO DEM/NTD</option>
                           <option value="TRACCIATO">TRACCIATO</option>
                           <option value="IGP">IGP</option>
                           <option value="CONVENZIONALE">CONVENZIONALE</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Varietà:</span>
                   <div class="form-input">
                       <select class="varieta-prodotto">
                           <option value="">Seleziona varietà</option>
                           ${varietyOptionsHtml}
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Linea:</span>
                   <div class="form-input">
                       <select class="linea-trasformazione" onchange="updateYieldByLine(${index}); calculateSupplier(${index});">
                           <option value="">Seleziona linea</option>
                           <option value="GOE EST/400">GOE EST/400</option>
                           <option value="BOE/1100">BOE/1100</option>
                           <option value="GOE EST/POLY">GOE EST/POLY</option>
                           <option value="GOE INT/POLY">GOE INT/POLY</option>
                           <option value="BIRILLATRICI">BIRILLATRICI</option>
                           <option value="GOE EST/BIRILLATRICI">GOE EST/BIRILLATRICI</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Portata (kg/h):</span>
                   <div class="form-input">
                       <input type="number" class="portata-impianto" min="100" max="5000" onchange="calculateEndTime(${index})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Inizio:</span>
                   <div class="form-input">
                       <input type="time" class="orario-inizio" onchange="calculateEndTime(${index})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Fine:</span>
                   <div class="form-input">
                       <div class="orario-fine-display calculated-field"></div>
                   </div>
               </div>

               <!-- Resa nascosta -->
               <input type="number" class="resa-prima hidden-field" value="${defaultYield}">

               <div class="form-row">
                   <span class="form-label">Succo 1ª (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-prima yield-result" readonly>
                   </div>
               </div>

               <!-- Sezione Destinazione Succo 1ª -->
               <div class="destination-section">
                   <div class="destination-section-header">Destinazione Succo 1ª</div>
                   
                   <div class="form-row">
                       <span class="form-label">Dest.:</span>
                       <div class="form-input">
                           <select class="destinazione-prima" onchange="updateDestinationCard(${index})">
                               <option value="">Destinazione succo 1ª</option>
                               <option value="NAT IN TINI">NAT IN TINI</option>
                               <option value="PET 100">PET 100</option>
                               <option value="PET 200">PET 200</option>
                               <option value="PET 480">PET 480</option>
                               <option value="ACMA">ACMA</option>
                               <option value="REX">REX</option>
                               <option value="GOGLIO">GOGLIO</option>
                               <option value="VASCHETTE">VASCHETTE</option>
                               <option value="LATTE">LATTE</option>
                               <option value="F.F.">F.F.</option>
                               <option value="F.T.C">F.T.C</option>
                               <option value="FBL">FBL</option>
                               <option value="BIC">BIC</option>
                               <option value="CISTERNA P">CISTERNA P</option>
                               <option value="CISTERNA EF">CISTERNA EF</option>
                               <option value="CISTERNA VK">CISTERNA VK</option>
                               <option value="CISTERNA GS">CISTERNA GS</option>
                               <option value="CONCENTRATO">CONCENTRATO</option>
                               <option value="ALTRO">ALTRO</option>
                           </select>
                       </div>
                   </div>
                   
                   <div class="remaining-qty">Rimanente: <span class="remaining-value">0</span> kg</div>
                   
                   <!-- Sezione trasferimento -->
                   <div class="transfer-row">
                       <span class="form-label">Invia:</span>
                       <select class="transfer-destination"></select>
                       <input type="number" class="transfer-qty" placeholder="kg" min="0" step="0.1">
                       <button type="button" class="btn btn-success" onclick="executeTransfer(${index})">
                           >
                       </button>
                   </div>
               </div>

               <!-- Pulsanti compatti -->
               <div style="margin-top: 5px; text-align: center;">
                   <button type="button" class="btn btn-danger" onclick="removeCard(${index}, 'supplier')" style="padding: 2px 5px; font-size: 8px;">
                       Rimuovi
                   </button>
               </div>
           </div>
       `;
   }

   // Crea card destinazione SEMPLIFICATA
   function createDestinazioneCard(index) {
       const position = getNextAvailablePosition();
       if (!position) {
           alert('Massimo 8 card raggiunto!');
           return null;
       }

       cardPositions.push(position);

       return `
           <div class="destinazione-card card-position-${position}" data-destinazione-index="${index}" data-position="${position}">
               <div class="destinazione-header">${index}ª Destinazione</div>
               
               <div class="form-row">
                   <span class="form-label">Succo 1ª (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-prima-dest" min="0" step="0.1">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Destinazione:</span>
                   <div class="form-input">
                       <select class="destinazione-prima-dest">
                           <option value="">Destinazione succo 1ª</option>
                           <option value="NAT IN TINI">NAT IN TINI</option>
                           <option value="PET 100">PET 100</option>
                           <option value="PET 200">PET 200</option>
                           <option value="PET 480">PET 480</option>
                           <option value="ACMA">ACMA</option>
                           <option value="REX">REX</option>
                           <option value="GOGLIO">GOGLIO</option>
                           <option value="VASCHETTE">VASCHETTE</option>
                           <option value="LATTE">LATTE</option>
                           <option value="F.F.">F.F.</option>
                           <option value="F.T.C">F.T.C</option>
                           <option value="FBL">FBL</option>
                           <option value="BIC">BIC</option>
                           <option value="CISTERNA P">CISTERNA P</option>
                           <option value="CISTERNA EF">CISTERNA EF</option>
                           <option value="CISTERNA VK">CISTERNA VK</option>
                           <option value="CISTERNA GS">CISTERNA GS</option>
                           <option value="CONCENTRATO">CONCENTRATO</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Polpa:</span>
                   <div class="form-input">
                       <select class="tenore-polpa-dest">
                           <option value="STANDARD">STANDARD</option>
                           <option value="LIMPIDO">LIMPIDO</option>
                           <option value="<1%"><1%</option>
                           <option value="2%">2%</option>
                           <option value="3%">3%</option>
                           <option value="6%">6%</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">°BX:</span>
                   <div class="form-input">
                       <select class="brix-dest">
                           <option value="NAT">NAT</option>
                           <option value="20">20</option>
                           <option value="32">32</option>
                           <option value="40">40</option>
                           <option value="45">45</option>
                           <option value="48">48</option>
                           <option value="50">50</option>
                           <option value="55">55</option>
                           <option value="60">60</option>
                           <option value="65">65</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Bio:</span>
                   <div class="form-input">
                       <select class="bio-dest">
                           <option value="SI">SI</option>
                           <option value="NO">NO</option>
                           <option value="DECLASSATO">DECLASSATO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Pastorizzato:</span>
                   <div class="form-input">
                       <select class="pastorizzato-dest">
                           <option value="SI">SI</option>
                           <option value="NO">NO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Conservato:</span>
                   <div class="form-input">
                       <select class="conservato-dest">
                           <option value="SI">SI</option>
                           <option value="NO" selected>NO</option>
                       </select>
                   </div>
               </div>

               <!-- Pulsanti compatti -->
               <div style="margin-top: 5px; text-align: center;">
                   <button type="button" class="btn btn-danger" onclick="removeCard(${index}, 'destinazione')" style="padding: 2px 5px; font-size: 8px;">
                       Rimuovi
                   </button>
               </div>
           </div>
       `;
   }

   // Funzioni di gestione
   window.updateSupplierName = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const nome = card.find('.nome-fornitore').val();
       const altroField = card.find('.altro-fornitore');
       
       if (nome === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
       
       const displayName = nome === 'ALTRO' ? (altroField.val() || 'Altro Fornitore') : nome;
       card.find('.supplier-name').text(displayName || 'Nuovo Fornitore');
       
       updateAllTransferOptions();
   };

   window.updateYieldByLine = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const linea = card.find('.linea-trasformazione').val();
       
       if (linea) {
           const yield = getYieldByLine(linea);
           card.find('.resa-prima').val(yield.toFixed(2));
       }
   };

   window.calculateSupplier = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       
       // Calcola giacenza
       const entrata = parseFloat(card.find('.quantita-fornitore').val()) || 0;
       const trasformata = parseFloat(card.find('.quantita-trasformata').val()) || 0;
       const giacenza = entrata - trasformata;
       card.find('.giacenza-fornitore').val(giacenza >= 0 ? giacenza : 0);
       
       // Calcola quantità prodotti
       const resaPrima = parseFloat(card.find('.resa-prima').val()) || 0;
       
       if (trasformata > 0) {
           const quantitaPrima = (trasformata * resaPrima / 100).toFixed(1);
           card.find('.quantita-prima').val(quantitaPrima);
       } else {
           card.find('.quantita-prima').val('');
       }
       
       calculateEndTime(index);
       updateTotals();
       updateDestinationCard(index);
   };

   window.calculateEndTime = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const quantitaTrasformata = parseFloat(card.find('.quantita-trasformata').val()) || 0;
       const portata = parseFloat(card.find('.portata-impianto').val()) || 0;
       const orarioInizio = card.find('.orario-inizio').val();
       
       if (quantitaTrasformata > 0 && portata > 0 && orarioInizio) {
           const durataTotaleMinuti = Math.round((quantitaTrasformata / portata) * 60);
           
           const dataLavorazione = $('#data-lavorazione').val();
           if (!dataLavorazione) {
               card.find('.orario-fine-display').html('');
               return;
           }
           
           const [oraInizio, minutiInizio] = orarioInizio.split(':').map(n => parseInt(n));
           const dataInizio = new Date(dataLavorazione);
           dataInizio.setHours(oraInizio, minutiInizio, 0, 0);
           
           const dataFine = new Date(dataInizio.getTime() + durataTotaleMinuti * 60 * 1000);
           
           const oreFine = dataFine.getHours().toString().padStart(2, '0');
           const minutiFine = dataFine.getMinutes().toString().padStart(2, '0');
           let orarioFineDisplay = `${oreFine}:${minutiFine}`;
           
           if (dataFine.getDate() !== dataInizio.getDate()) {
               const giornoSuccessivo = dataFine.getDate();
               orarioFineDisplay += ` (g.${giornoSuccessivo})`;
           }
           
           card.find('.orario-fine-display').html(orarioFineDisplay);
       } else {
           card.find('.orario-fine-display').html('');
       }
   };

   window.updateBioStyles = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const certificazione = card.find('.certificazione-prodotto').val();
       
       // Reset tutti gli stili
       card.find('.certificazione-prodotto').removeClass('bio-red-field bio-black-field');
       card.find('.varieta-prodotto').removeClass('bio-red-field bio-black-field');
       card.find('.linea-trasformazione').removeClass('bio-red-field bio-black-field');
       
       const isBioSpecific = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(certificazione);
       
       if (isBioSpecific) {
           card.find('.certificazione-prodotto').addClass('bio-red-field');
           card.find('.varieta-prodotto').addClass('bio-red-field');
           card.find('.linea-trasformazione').addClass('bio-red-field');
       }
   };

   window.updateDestinationCard = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const quantitaPrima = parseFloat(card.find('.quantita-prima').val()) || 0;
       const totalTransferred = transferredAmounts[index] || 0;
       const available = quantitaPrima - totalTransferred;
       
       card.find('.remaining-value').text(available.toFixed(1));
       card.find('.transfer-qty').val(available > 0 ? available.toFixed(1) : '');
       
       updateTransferOptions(index);
   };

   function updateTransferOptions(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const transferSelect = card.find('.transfer-destination');
       
       transferSelect.empty().append('<option value="">Dest.</option>');
       
       // Aggiungi fornitori
       $('.supplier-card').each(function() {
           const otherIndex = $(this).data('supplier-index');
           if (otherIndex !== index) {
               const nome = $(this).find('.nome-fornitore').val();
               const altroNome = $(this).find('.altro-fornitore').val();
               
               let displayName = '';
               if (nome === 'ALTRO' && altroNome) {
                   displayName = altroNome;
               } else if (nome && nome !== 'ALTRO') {
                   displayName = nome;
               }
               
               if (displayName) {
                   transferSelect.append(`<option value="supplier_${otherIndex}">F${otherIndex}</option>`);
               }
           }
       });
       
       // Aggiungi destinazioni
       $('.destinazione-card').each(function() {
           const destIndex = $(this).data('destinazione-index');
           transferSelect.append(`<option value="dest_${destIndex}">D${destIndex}</option>`);
       });
   }

   function updateAllTransferOptions() {
       $('.supplier-card').each(function() {
           const index = $(this).data('supplier-index');
           updateTransferOptions(index);
       });
   }

   window.executeTransfer = function(sourceIndex) {
       const sourceCard = $(`.supplier-card[data-supplier-index="${sourceIndex}"]`);
       const targetValue = sourceCard.find('.transfer-destination').val();
       const transferAmount = parseFloat(sourceCard.find('.transfer-qty').val()) || 0;
       
       if (!targetValue) {
           alert('Seleziona la destinazione');
           return;
       }
       
       if (transferAmount <= 0) {
           alert('Inserisci quantità valida');
           return;
       }
       
       const remaining = parseFloat(sourceCard.find('.remaining-value').text()) || 0;
       if (transferAmount > remaining) {
           alert('Quantità superiore al rimanente');
           return;
       }
       
       if (targetValue.startsWith('supplier_')) {
           const targetIndex = targetValue.replace('supplier_', '');
           const targetCard = $(`.supplier-card[data-supplier-index="${targetIndex}"]`);
           
           const currentTargetQty = parseFloat(targetCard.find('.quantita-prima').val()) || 0;
           const newTargetQty = currentTargetQty + transferAmount;
           targetCard.find('.quantita-prima').val(newTargetQty.toFixed(1));
           
           updateDestinationCard(targetIndex);
           
       } else if (targetValue.startsWith('dest_')) {
           const targetIndex = targetValue.replace('dest_', '');
           const targetCard = $(`.destinazione-card[data-destinazione-index="${targetIndex}"]`);
           
           const currentTargetQty = parseFloat(targetCard.find('.quantita-prima-dest').val()) || 0;
           const newTargetQty = currentTargetQty + transferAmount;
           targetCard.find('.quantita-prima-dest').val(newTargetQty.toFixed(1));
       }
       
       // Traccia trasferimento
       if (!transferredAmounts[sourceIndex]) {
           transferredAmounts[sourceIndex] = 0;
       }
       transferredAmounts[sourceIndex] += transferAmount;
       
       // Reset campi
       sourceCard.find('.transfer-destination').val('');
       sourceCard.find('.transfer-qty').val('');
       
       updateDestinationCard(sourceIndex);
       
       alert(`Trasferimento di ${transferAmount} kg completato!`);
   };

   window.removeCard = function(index, type) {
       if (confirm('Sei sicuro di voler rimuovere questa card?')) {
           let card;
           if (type === 'supplier') {
               card = $(`.supplier-card[data-supplier-index="${index}"]`);
               // Rimuovi dati trasferimenti
               delete transferredAmounts[index];
           } else {
               card = $(`.destinazione-card[data-destinazione-index="${index}"]`);
           }
           
           const position = card.data('position');
           cardPositions = cardPositions.filter(p => p !== position);
           
           card.remove();
           cardCounter--;
           
           updateTotals();
           updateCardsCount();
           updateAllTransferOptions();
       }
   };

   function updateTotals() {
       let totaleEntrata = 0;
       let totaleTrasformata = 0;
       let totaleGiacenza = 0;
       
       $('.supplier-card').each(function() {
           const entrata = parseFloat($(this).find('.quantita-fornitore').val()) || 0;
           const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
           const giacenza = parseFloat($(this).find('.giacenza-fornitore').val()) || 0;
           
           totaleEntrata += entrata;
           totaleTrasformata += trasformata;
           totaleGiacenza += giacenza;
       });
       
       $('#entrata-giornaliera-display').text(totaleEntrata.toLocaleString());
       $('#trasformata-totale-display').text(totaleTrasformata.toLocaleString());
       $('#giacenza-totale-display').text(totaleGiacenza.toLocaleString());
   }

   function updateCardsCount() {
       const count = $('.supplier-card').length + $('.destinazione-card').length;
       $('#cards-count').text(count);
   }

   function updateVarietyOptions(agrume) {
       $('.supplier-card').each(function() {
           const varietaSelect = $(this).find('.varieta-prodotto');
           const currentValue = varietaSelect.val();
           
           varietaSelect.empty();
           varietaSelect.append('<option value="">Seleziona varietà</option>');
           
           if (agrume && varietyOptions[agrume]) {
               varietyOptions[agrume].forEach(function(variety) {
                   varietaSelect.append(`<option value="${variety.value}">${variety.text}</option>`);
               });
           }
           
           if (currentValue) {
               varietaSelect.val(currentValue);
           }
       });
   }

   function showSaveStatus(message, type) {
       const statusDiv = $('#save-status');
       const messageSpan = $('#save-message');
       
       messageSpan.text(message);
       
       if (type === 'error') {
           statusDiv.addClass('save-error').removeClass('save-status');
       } else {
           statusDiv.removeClass('save-error').addClass('save-status');
       }
       
       statusDiv.fadeIn();
       
       setTimeout(() => {
           statusDiv.fadeOut();
       }, 3000);
   }

   // Eventi principali
   $('#tipo-agrume-giornaliero').change(function() {
       const agrume = $(this).val();
       $('#selected-agrume').text(agrume || 'N/D');
       
       if (agrume) {
           $('.supplier-card').each(function() {
               const index = $(this).data('supplier-index');
               calculateSupplier(index);
               updateDestinationCard(index);
           });
           
           updateVarietyOptions(agrume);
           updateTotals();
       }
   });

   $('#aggiungi-fornitore').click(function() {
       if (!$('#tipo-agrume-giornaliero').val()) {
           alert('Seleziona prima il tipo di agrume');
           return;
       }
       
       if (cardCounter >= 8) {
           alert('Massimo 8 card raggiunto!');
           return;
       }
       
       supplierCount++;
       cardCounter++;
       
       const newCard = createSupplierCard(supplierCount);
       if (newCard) {
           $('#main-grid').append(newCard);
           updateCardsCount();
           updateAllTransferOptions();
       }
   });

   $('#aggiungi-destinazione').click(function() {
       if (cardCounter >= 8) {
           alert('Massimo 8 card raggiunto!');
           return;
       }
       
       destinazioneCount++;
       cardCounter++;
       
       const newCard = createDestinazioneCard(destinazioneCount);
       if (newCard) {
           $('#main-grid').append(newCard);
           updateCardsCount();
           updateAllTransferOptions();
       }
   });

   $('#reset-programma').click(function() {
       if (confirm('Attenzione: questa operazione cancellerà tutti i dati inseriti. Continuare?')) {
           location.reload();
       }
   });

   // Inizializzazione
   initCurrentDate();
   updateCardsCount();

   console.log('Sistema Programma Giornaliero Trasformazione inizializzato - Layout 4x2 semplificato');
});
</script>
</body>
</html>
