<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
* {
   margin: 0;
   padding: 0;
   box-sizing: border-box;
}

body { 
   font-family: 'Arial', sans-serif;
   font-size: 18px;
   line-height: 1.4;
   color: #000000;
   margin: 20px;
   background-color: #f5f5f5;
}

.header {
   text-align: center;
   margin-bottom: 20px;
   background: #1e3c72;
   border: 2px solid #000000;
   padding: 15px;
   border-radius: 8px;
   color: #ffffff;
}

.header h1 {
   font-size: 24px;
   margin-bottom: 8px;
   font-weight: bold;
   color: #ffffff;
}

.header .subtitle {
   font-size: 20px;
   margin-bottom: 8px;
   color: #ffffff;
}

.header-info {
   display: flex;
   justify-content: space-around;
   margin-top: 10px;
   font-size: 17px;
   color: #ffffff;
}

.controls-section {
   background-color: #e9ecef;
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 15px;
   margin-bottom: 20px;
   display: flex;
   gap: 20px;
   align-items: center;
   flex-wrap: wrap;
}

.controls-section .form-group {
   display: flex;
   flex-direction: column;
   min-width: 200px;
}

.controls-section label {
   font-weight: bold;
   margin-bottom: 5px;
   color: #000000;
}

.controls-section .form-control,
.controls-section .form-select {
   border: 1px solid #000000;
   border-radius: 4px;
   padding: 8px;
   font-size: 16px;
}

.btn {
   padding: 10px 20px;
   border: none;
   border-radius: 5px;
   font-weight: bold;
   cursor: pointer;
   text-decoration: none;
   display: inline-block;
   margin: 5px;
}

.btn-primary {
   background: #1e3c72;
   color: white;
}

.btn-success {
   background: #28a745;
   color: white;
}

.btn-warning {
   background: #ffc107;
   color: #000000;
}

.btn-danger {
   background: #dc3545;
   color: white;
}

.btn-info {
   background: #17a2b8;
   color: white;
}

.totals-section {
   display: flex;
   justify-content: space-around;
   margin-bottom: 20px;
   background-color: #ffc107;
   padding: 15px;
   border: 1px solid #000000;
   border-radius: 5px;
}

.total-item {
   text-align: center;
   color: #000000;
}

.total-value {
   font-size: 22px;
   font-weight: bold;
   color: #000000;
}

.total-label {
   font-size: 16px;
   margin-top: 3px;
   color: #000000;
}

/* NUOVO LAYOUT A GRIGLIA 4x2 */
.grid-container {
   display: grid;
   grid-template-columns: repeat(4, 1fr);
   grid-template-rows: repeat(2, 1fr);
   gap: 10px;
   height: calc(100vh - 300px);
   min-height: 600px;
   margin-bottom: 20px;
}

.grid-item {
   background-color: #e9ecef;
   border: 2px solid #000000;
   border-radius: 8px;
   padding: 15px;
   display: flex;
   flex-direction: column;
   justify-content: flex-start;
   min-height: 280px;
}

/* Card Fornitore */
.supplier-card {
   background-color: #e9ecef;
   border: 2px solid #6c757d;
}

.supplier-header {
   background: #6c757d;
   color: #ffffff;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 16px;
   margin: -15px -15px 15px -15px;
   border-radius: 6px 6px 0 0;
}

/* Card Destinazione */
.destination-card {
   background-color: #f0f8ff;
   border: 2px solid #007bff;
}

.destination-header {
   background: #007bff;
   color: #ffffff;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 16px;
   margin: -15px -15px 15px -15px;
   border-radius: 6px 6px 0 0;
}

.form-row {
   display: flex;
   justify-content: space-between;
   margin-bottom: 8px;
   align-items: center;
}

.form-label {
   font-weight: bold;
   color: #000000;
   width: 40%;
   font-size: 12px;
}

.form-input {
   width: 58%;
}

.form-input input,
.form-input select {
   width: 100%;
   border: 1px solid #000000;
   border-radius: 4px;
   padding: 4px;
   font-size: 11px;
}

.calculated-field {
   background-color: #e7f3ff;
   font-weight: bold;
   text-align: center;
}

.yield-result {
   background-color: #e8f5e8;
   font-weight: bold;
   text-align: center;
}

.remaining-display {
   background-color: #e7f3ff;
   border: 1px solid #2a5298;
   padding: 4px;
   border-radius: 3px;
   font-weight: bold;
   text-align: center;
   color: #1e3c72;
   font-size: 11px;
   margin: 5px 0;
}

.transfer-row {
   display: flex;
   gap: 5px;
   align-items: center;
   margin-top: 8px;
}

.transfer-select {
   flex: 1;
   font-size: 10px;
   padding: 2px;
}

.transfer-btn {
   padding: 2px 6px;
   font-size: 9px;
   margin: 0;
}

.hidden-field {
   display: none;
}

.section-divider {
   border-bottom: 1px solid #6c757d;
   margin: 8px 0;
}

/* Stili per stampa A4 */
@media print {
   body {
       margin: 5mm;
       background-color: white;
       font-size: 12px;
   }
   
   .controls-section {
       display: none;
   }
   
   .btn {
       display: none;
   }
   
   .header {
       background: #1e3c72;
       color: #ffffff;
       border: 2px solid #000000;
       padding: 10px;
       margin-bottom: 10px;
   }
   
   .header h1 {
       font-size: 20px;
       color: #ffffff;
   }
   
   .header .subtitle {
       font-size: 16px;
       color: #ffffff;
   }
   
   .header-info {
       font-size: 14px;
       color: #ffffff;
   }
   
   .totals-section {
       background-color: #ffc107;
       border: 2px solid #000000;
       padding: 10px;
       margin-bottom: 10px;
   }
   
   .total-value {
       font-size: 18px;
       color: #000000;
   }
   
   .total-label {
       font-size: 12px;
       color: #000000;
   }
   
   .grid-container {
       height: auto;
       min-height: auto;
       page-break-inside: avoid;
   }
   
   .grid-item {
       font-size: 10px;
       padding: 8px;
       min-height: 200px;
       page-break-inside: avoid;
   }
   
   .supplier-header,
   .destination-header {
       font-size: 12px;
       padding: 4px;
       margin: -8px -8px 8px -8px;
   }
   
   .form-label {
       font-size: 9px;
   }
   
   .form-input input,
   .form-input select {
       font-size: 9px;
       padding: 2px;
   }
   
   @page {
       margin: 5mm;
       size: A4 landscape;
   }
}
</style>
</head>

<body>
   <div class="header">
       <h1>PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
       <div class="subtitle">Sistema di Gestione Produzione - Simone Gatto</div>
       <div class="header-info">
           <div><strong>Data:</strong> <span id="current-date"></span></div>
           <div><strong>Agrume:</strong> <span id="selected-agrume">N/D</span></div>
           <div><strong>Elementi:</strong> <span id="elements-count">0</span></div>
       </div>
       <div style="margin-top: 10px; font-size: 16px;">
           <strong>Generato:</strong> <span id="last-revision"></span>
       </div>
   </div>

   <div class="controls-section">
       <div class="form-group">
           <label for="tipo-agrume-giornaliero">Tipo di Agrume</label>
           <select class="form-select" id="tipo-agrume-giornaliero" required>
               <option value="">Seleziona il tipo di agrume</option>
               <option value="LIMONE">Limone</option>
               <option value="ARANCIA">Arancia</option>
               <option value="MANDARINO">Mandarino</option>
               <option value="POMPELMO">Pompelmo</option>
               <option value="BERGAMOTTO">Bergamotto</option>
           </select>
       </div>
       
       <div class="form-group">
           <label for="data-lavorazione">Data Lavorazione</label>
           <input type="date" class="form-control" id="data-lavorazione" required>
       </div>
       
       <div>
           <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
               <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
           </button>
           <button type="button" class="btn btn-success" id="aggiungi-destinazione">
               <i class="bi bi-plus-square"></i> Aggiungi Destinazione
           </button>
           <button type="button" class="btn btn-warning" onclick="window.print()">
               <i class="bi bi-printer"></i> Stampa
           </button>
           <button type="button" class="btn btn-danger" id="reset-programma">
               <i class="bi bi-arrow-clockwise"></i> Reset
           </button>
       </div>
   </div>

   <div class="totals-section">
       <div class="total-item">
           <div class="total-value" id="entrata-totale-display">0</div>
           <div class="total-label">Kg Entrata Totale</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="trasformata-totale-display">0</div>
           <div class="total-label">Kg Trasformati</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="giacenza-totale-display">0</div>
           <div class="total-label">Kg Giacenza</div>
       </div>
   </div>

   <!-- Griglia 4x2 per contenere 8 riquadri -->
   <div class="grid-container" id="grid-container">
       <!-- Gli elementi verranno aggiunti dinamicamente qui -->
   </div>

<script>
$(document).ready(function() {
   let elementCount = 0;
   let supplierCount = 0;
   let destinationCount = 0;

   // Definizione varietà per ogni tipo di agrume
   const varietyOptions = {
       'LIMONE': [
           { value: 'VERDELLO', text: 'Verdello' },
           { value: 'FEMMINELLO', text: 'Femminello' },
           { value: 'INTERDONATO', text: 'Interdonato' },
           { value: 'BIANCHETTO', text: 'Bianchetto' },
           { value: 'MONACHELLO', text: 'Monachello' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro' }
       ],
       'MANDARINO': [
           { value: 'TARD. DI CIACULLI', text: 'Tard. di Ciaculli' },
           { value: 'AVANA', text: 'Avana' },
           { value: 'CLEMENTINO', text: 'Clementino' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro' }
       ],
       'ARANCIA': [
           { value: 'BIONDA', text: 'Bionda' },
           { value: 'ROSSA', text: 'Rossa' },
           { value: 'MORO', text: 'Moro' },
           { value: 'SANGUINELLA', text: 'Sanguinella' },
           { value: 'TAROCCO', text: 'Tarocco' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro' }
       ],
       'BERGAMOTTO': [
           { value: 'FEMMINELLO', text: 'Femminello' },
           { value: 'CASTAGNARO', text: 'Castagnaro' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro' }
       ],
       'POMPELMO': [
           { value: 'GIALLO', text: 'Giallo' },
           { value: 'ROSA', text: 'Rosa' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro' }
       ]
   };

   // Rese per linea di trasformazione
   const yieldsPerLine = {
       'BOE/1100': 31.30,
       'GOE EST/400': 31.60,
       'GOE EST/POLY': 30.60,
       'GOE INT/POLY': 28.30,
       'BIRILLATRICI': 26.60,
       'GOE EST/BIRILLATRICI': 25.60
   };

   // Inizializzazione data corrente
   function initCurrentDate() {
       const today = new Date();
       const formatted = today.toLocaleDateString('it-IT', {
           weekday: 'long',
           year: 'numeric',
           month: 'long',
           day: 'numeric'
       });
       $('#current-date').text(formatted);
       $('#data-lavorazione').val(today.toISOString().split('T')[0]);
       updateLastRevision();
   }

   function updateLastRevision() {
       const now = new Date();
       const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
       $('#last-revision').text(lastRevision);
   }

   // Funzione per ottenere la resa in base alla linea
   function getYieldByLine(linea) {
       return yieldsPerLine[linea] || 30;
   }

   // Funzione per calcolare la posizione nella griglia
   function getGridPosition(elementIndex) {
       // La logica è: primo elemento va in alto a sinistra (1,1)
       // secondo elemento va sotto il primo (2,1) 
       // terzo elemento va in alto seconda colonna (1,2)
       // quarto elemento va sotto il terzo (2,2) e così via
       
       const columnIndex = Math.floor((elementIndex - 1) / 2);
       const rowIndex = ((elementIndex - 1) % 2) + 1;
       
       return {
           column: columnIndex + 1,
           row: rowIndex,
           gridColumn: columnIndex + 1,
           gridRow: rowIndex
       };
   }

   // Crea card fornitore semplificata
   function createSupplierCard(index) {
       const agrume = $('#tipo-agrume-giornaliero').val();
       const varietyOptionsHtml = agrume && varietyOptions[agrume] ? 
           varietyOptions[agrume].map(v => `<option value="${v.value}">${v.text}</option>`).join('') : 
           '<option value="">Seleziona varietà</option>';

       return `
           <div class="grid-item supplier-card" data-supplier-index="${index}" data-element-type="supplier">
               <div class="supplier-header">Fornitore ${index}</div>
               
               <div class="form-row">
                   <span class="form-label">Nome:</span>
                   <div class="form-input">
                       <select class="nome-fornitore" onchange="updateSupplierName(${index})">
                           <option value="">Seleziona fornitore</option>
                           <option value="RESTUCCIA">RESTUCCIA</option>
                           <option value="CI">CI</option>
                           <option value="ARCO">ARCO</option>
                           <option value="GIOVINAZZO">GIOVINAZZO</option>
                           <option value="AZ.T.C.">AZ.T.C.</option>
                           <option value="M.B.T.F.">M.B.T.F.</option>
                           <option value="VASTA">VASTA</option>
                           <option value="APAL">APAL</option>
                           <option value="GEIMA">GEIMA</option>
                           <option value="UNIONBERG">UNIONBERG</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Entrata (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-entrata" min="0" onchange="calculateSupplier(${index})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Trasformata (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-trasformata" min="0" onchange="calculateSupplier(${index})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Giacenza (kg):</span>
                   <div class="form-input">
                       <input type="number" class="giacenza calculated-field" readonly>
                   </div>
               </div>

               <div class="section-divider"></div>

               <div class="form-row">
                   <span class="form-label">Certificazione:</span>
                   <div class="form-input">
                       <select class="certificazione">
                           <option value="">Seleziona</option>
                           <option value="BIO EU">BIO EU</option>
                           <option value="BIO DEM">BIO DEM</option>
                           <option value="BIO NTD">BIO NTD</option>
                           <option value="TRACCIATO">TRACCIATO</option>
                           <option value="CONVENZIONALE">CONVENZIONALE</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Varietà:</span>
                   <div class="form-input">
                       <select class="varieta">
                           <option value="">Seleziona varietà</option>
                           ${varietyOptionsHtml}
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Linea:</span>
                   <div class="form-input">
                       <select class="linea" onchange="updateYieldAndCalculate(${index})">
                           <option value="">Seleziona linea</option>
                           <option value="GOE EST/400">GOE EST/400</option>
                           <option value="BOE/1100">BOE/1100</option>
                           <option value="GOE EST/POLY">GOE EST/POLY</option>
                           <option value="GOE INT/POLY">GOE INT/POLY</option>
                           <option value="BIRILLATRICI">BIRILLATRICI</option>
                           <option value="GOE EST/BIRILLATRICI">GOE EST/BIRILLATRICI</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Portata (kg/h):</span>
                   <div class="form-input">
                       <input type="number" class="portata" min="100" max="5000" onchange="calculateEndTime(${index})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Inizio:</span>
                   <div class="form-input">
                       <input type="time" class="orario-inizio" onchange="calculateEndTime(${index})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Fine:</span>
                   <div class="form-input">
                       <input type="text" class="orario-fine calculated-field" readonly>
                   </div>
               </div>

               <div class="section-divider"></div>

               <div class="form-row">
                   <span class="form-label">Succo 1ª (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-succo yield-result" readonly>
                   </div>
               </div>

               <!-- Campo resa nascosto -->
               <input type="hidden" class="resa-prima" value="30">

               <div style="margin-top: 8px; text-align: center;">
                   <button type="button" class="btn btn-danger btn-sm" onclick="removeElement(${index}, 'supplier')" style="padding: 2px 8px; font-size: 10px;">
                       Rimuovi
                   </button>
               </div>
           </div>
       `;
   }

   // Crea card destinazione semplificata
   function createDestinationCard(index) {
       return `
           <div class="grid-item destination-card" data-destination-index="${index}" data-element-type="destination">
               <div class="destination-header">Destinazione ${index}</div>
               
               <div class="form-row">
                   <span class="form-label">Dest.:</span>
                   <div class="form-input">
                       <select class="destinazione-select">
                           <option value="">Destinazione succo 1ª</option>
                           <option value="NAT IN TINI">NAT IN TINI</option>
                           <option value="PET 100">PET 100</option>
                           <option value="PET 200">PET 200</option>
                           <option value="PET 480">PET 480</option>
                           <option value="ACMA">ACMA</option>
                           <option value="REX">REX</option>
                           <option value="GOGLIO">GOGLIO</option>
                           <option value="VASCHETTE">VASCHETTE</option>
                           <option value="LATTE">LATTE</option>
                           <option value="F.F.">F.F.</option>
                           <option value="F.T.C">F.T.C</option>
                           <option value="FBL">FBL</option>
                           <option value="BIC">BIC</option>
                           <option value="CISTERNA P">CISTERNA P</option>
                           <option value="CISTERNA EF">CISTERNA EF</option>
                           <option value="CISTERNA VK">CISTERNA VK</option>
                           <option value="CISTERNA GS">CISTERNA GS</option>
                           <option value="CONCENTRATO">CONCENTRATO</option>
                       </select>
                   </div>
               </div>

               <div class="remaining-display">Rimanente: <span class="remaining-value">0</span> kg</div>

               <div class="transfer-row">
                   <span class="form-label">Invia:</span>
                   <select class="transfer-destination transfer-select">
                       <option value="">Dest.</option>
                   </select>
                   <button type="button" class="btn btn-success transfer-btn" onclick="executeTransfer(${index})">
                       Invia
                   </button>
               </div>

               <div style="margin-top: 8px; text-align: center;">
                   <button type="button" class="btn btn-danger btn-sm" onclick="removeElement(${index}, 'destination')" style="padding: 2px 8px; font-size: 10px;">
                       Rimuovi
                   </button>
               </div>
           </div>
       `;
   }

   // Funzione per posizionare elemento nella griglia
   function positionElementInGrid(element, elementIndex) {
       const position = getGridPosition(elementIndex);
       element.css({
           'grid-column': position.gridColumn,
           'grid-row': position.gridRow
       });
   }

   // Funzioni di calcolo
   window.updateSupplierName = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const nome = card.find('.nome-fornitore').val();
       
       if (nome) {
           card.find('.supplier-header').text(`Fornitore ${index} - ${nome}`);
       } else {
           card.find('.supplier-header').text(`Fornitore ${index}`);
       }
       
       updateTransferOptions();
   };

   window.updateYieldAndCalculate = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const linea = card.find('.linea').val();
       
       if (linea) {
           const yield = getYieldByLine(linea);
           card.find('.resa-prima').val(yield);
       }
       
       calculateSupplier(index);
   };

   window.calculateSupplier = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       
       // Calcola giacenza
       const entrata = parseFloat(card.find('.quantita-entrata').val()) || 0;
       const trasformata = parseFloat(card.find('.quantita-trasformata').val()) || 0;
       const giacenza = entrata - trasformata;
       card.find('.giacenza').val(giacenza >= 0 ? giacenza : 0);
       
       // Calcola quantità succo
       const resa = parseFloat(card.find('.resa-prima').val()) || 30;
       if (trasformata > 0) {
           const quantitaSucco = (trasformata * resa / 100).toFixed(1);
           card.find('.quantita-succo').val(quantitaSucco);
       } else {
           card.find('.quantita-succo').val('');
       }
       
       calculateEndTime(index);
       updateTotals();
   };

   window.calculateEndTime = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const quantitaTrasformata = parseFloat(card.find('.quantita-trasformata').val()) || 0;
       const portata = parseFloat(card.find('.portata').val()) || 0;
       const orarioInizio = card.find('.orario-inizio').val();
       
       if (quantitaTrasformata > 0 && portata > 0 && orarioInizio) {
           const durataTotaleMinuti = Math.round((quantitaTrasformata / portata) * 60);
           
           const [oraInizio, minutiInizio] = orarioInizio.split(':').map(n => parseInt(n));
           const dataInizio = new Date();
           dataInizio.setHours(oraInizio, minutiInizio, 0, 0);
           
           const dataFine = new Date(dataInizio.getTime() + durataTotaleMinuti * 60 * 1000);
           
           const oreFine = dataFine.getHours().toString().padStart(2, '0');
           const minutiFine = dataFine.getMinutes().toString().padStart(2, '0');
           
           card.find('.orario-fine').val(`${oreFine}:${minutiFine}`);
       } else {
           card.find('.orario-fine').val('');
       }
   };

   // Aggiorna opzioni di trasferimento
   function updateTransferOptions() {
       $('.transfer-destination').each(function() {
           const select = $(this);
           select.empty().append('<option value="">Dest.</option>');
           
           // Aggiungi tutti i fornitori come opzioni
           $('.supplier-card').each(function() {
               const supplierIndex = $(this).data('supplier-index');
               const nome = $(this).find('.nome-fornitore').val() || `F${supplierIndex}`;
               select.append(`<option value="supplier_${supplierIndex}">${nome}</option>`);
           });
           
           // Aggiungi altre destinazioni
           $('.destination-card').each(function() {
               const destIndex = $(this).data('destination-index');
               const currentDestIndex = select.closest('.destination-card').data('destination-index');
               
               if (destIndex !== currentDestIndex) {
                   select.append(`<option value="destination_${destIndex}">Dest ${destIndex}</option>`);
               }
           });
       });
   }

   // Esegui trasferimento
   window.executeTransfer = function(sourceIndex) {
       const sourceCard = $(`.destination-card[data-destination-index="${sourceIndex}"]`);
       const targetValue = sourceCard.find('.transfer-destination').val();
       
       if (!targetValue) {
           alert('Seleziona la destinazione del trasferimento');
           return;
       }
       
       // Logica di trasferimento semplificata
       alert(`Trasferimento da Destinazione ${sourceIndex} a ${targetValue} eseguito!`);
       
       // Reset selezione
       sourceCard.find('.transfer-destination').val('');
   };

   // Rimuovi elemento
   window.removeElement = function(index, type) {
       if (confirm(`Sei sicuro di voler rimuovere questo ${type === 'supplier' ? 'fornitore' : 'destinazione'}?`)) {
           if (type === 'supplier') {
               $(`.supplier-card[data-supplier-index="${index}"]`).remove();
           } else {
               $(`.destination-card[data-destination-index="${index}"]`).remove();
           }
           
           reorganizeGrid();
           updateTotals();
           updateElementsCount();
           updateTransferOptions();
       }
   };

   // Riorganizza griglia dopo rimozione
   function reorganizeGrid() {
       const elements = $('#grid-container .grid-item').detach();
       
       elements.each(function(index) {
           const position = getGridPosition(index + 1);
           $(this).css({
               'grid-column': position.gridColumn,
               'grid-row': position.gridRow
           });
       });
       
       $('#grid-container').append(elements);
   }

   // Aggiorna totali
   function updateTotals() {
       let totaleEntrata = 0;
       let totaleTrasformata = 0;
       let totaleGiacenza = 0;
       
       $('.supplier-card').each(function() {
           const entrata = parseFloat($(this).find('.quantita-entrata').val()) || 0;
           const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
           const giacenza = parseFloat($(this).find('.giacenza').val()) || 0;
           
           totaleEntrata += entrata;
           totaleTrasformata += trasformata;
           totaleGiacenza += giacenza;
       });
       
       $('#entrata-totale-display').text(totaleEntrata.toLocaleString());
       $('#trasformata-totale-display').text(totaleTrasformata.toLocaleString());
       $('#giacenza-totale-display').text(totaleGiacenza.toLocaleString());
   }

   function updateElementsCount() {
       const count = $('#grid-container .grid-item').length;
       $('#elements-count').text(count);
   }

   // Aggiorna varietà quando cambia agrume
   function updateVarietyOptions(agrume) {
       $('.supplier-card').each(function() {
           const varietaSelect = $(this).find('.varieta');
           const currentValue = varietaSelect.val();
           
           varietaSelect.empty();
           varietaSelect.append('<option value="">Seleziona varietà</option>');
           
           if (agrume && varietyOptions[agrume]) {
               varietyOptions[agrume].forEach(function(variety) {
                   varietaSelect.append(`<option value="${variety.value}">${variety.text}</option>`);
               });
           }
           
           if (currentValue) {
               varietaSelect.val(currentValue);
           }
       });
   }

   // Eventi principali
   $('#tipo-agrume-giornaliero').change(function() {
       const agrume = $(this).val();
       $('#selected-agrume').text(agrume || 'N/D');
       
       if (agrume) {
           updateVarietyOptions(agrume);
           
           // Ricalcola tutti i fornitori
           $('.supplier-card').each(function() {
               const index = $(this).data('supplier-index');
               calculateSupplier(index);
           });
           
           updateTotals();
       }
   });

   $('#aggiungi-fornitore').click(function() {
       if (!$('#tipo-agrume-giornaliero').val()) {
           alert('Seleziona prima il tipo di agrume');
           return;
       }
       
       if (elementCount >= 8) {
           alert('Massimo 8 elementi consentiti per pagina');
           return;
       }
       
       elementCount++;
       supplierCount++;
       
       const newCard = $(createSupplierCard(supplierCount));
       positionElementInGrid(newCard, elementCount);
       $('#grid-container').append(newCard);
       
       updateElementsCount();
       updateTransferOptions();
   });

   $('#aggiungi-destinazione').click(function() {
       if (elementCount >= 8) {
           alert('Massimo 8 elementi consentiti per pagina');
           return;
       }
       
       elementCount++;
       destinationCount++;
       
       const newCard = $(createDestinationCard(destinationCount));
       positionElementInGrid(newCard, elementCount);
       $('#grid-container').append(newCard);
       
       updateElementsCount();
       updateTransferOptions();
   });

   $('#reset-programma').click(function() {
       if (confirm('Attenzione: questa operazione cancellerà tutti i dati inseriti. Continuare?')) {
           location.reload();
       }
   });

   // Inizializzazione
   initCurrentDate();
   updateElementsCount();

   console.log('Sistema Programma Giornaliero Trasformazione inizializzato - Layout griglia 4x2');
});
</script>
</body>
</html>
